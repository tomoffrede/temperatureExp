---
title: "Analysis - Speech Prosody"
author: "Tom Offrede"
date: "2023-11-27"
output: 
  html_document:
    toc: true
    toc_depth: 5
    toc_float: 
      collapsed: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Notes
 
* The first section of this file contains only the significant findings, and the second half, only null-results. (Exception: all f0 results are in the "significant" section.)

# ONLY SIGNIFICANT FINDINGS

# SPEECH ANALYSIS

```{r include=FALSE}
library(tidyverse)
library(lmerTest)
library(DHARMa)
library(broom)
library(parsnip)
library(nnet)
library(emmeans)

load(paste0(here::here(), "/data/speechData.RData"))
load(paste0(here::here(), "/data/speechData-allIPUs.RData"))
load(paste0(here::here(), "/data/individualTemp.RData"))
load(paste0(here::here(), "/data/metadata-clean.RData"))
meta <- m
```

## Speech adaptation (regardless of interlocutor)

### Numerical measure (all speakers together)

#### f0 median

Effect not significant

#### f0 max

-   Only during question lists: f0 max tends to decrease only in the *impersonal* condition, but if we're being strict (AIC of model with `condition` was 1.7 smaller than without), there f0 max went down in both conditions.

```{r, include=FALSE}
load(paste0(here::here(), "/data/speechData-allIPUs.RData"))
# ipus <- ipus |>
#   filter(gender != "Male")
```

```{r}
ggplot(ipus |> filter(task=="Lists"), aes(turnOverall, f0maxz))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~condition)+
  ggtitle("Question lists (1st part of experiment)")
summary(m <- lmer(f0maxz ~ turnOverall + (1|speaker), ipus |> filter(task=="Lists"))) # the model doesn't converge with random slopes, even after deleting the random intercepts
par(mfrow=c(2, 2))
hist(resid(m))
qqnorm(resid(m));qqline(resid(m))
plot(fitted(m), resid(m))
```

#### f0 SD

-   Only during question lists: f0 SD decreases in both conditions.

```{r, include=FALSE}
load(paste0(here::here(), "/data/speechData-allIPUs.RData"))
# ipus <- ipus |>
#   filter(gender != "Male")
```

```{r}
ggplot(ipus |> filter(task=="Lists"), aes(turnOverall, f0sdz))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~condition)+
  ggtitle("Question lists (1st part of experiment)")
summary(m <- lmer(f0sdz ~ turnOverall + (turnOverall||speaker), ipus |> filter(task=="Lists"))) # the model doesn't converge with random intercepts AND slopes
summary(m <- lmer(f0sdz ~ turnOverall + (1|speaker), ipus |> filter(task=="Lists")))
par(mfrow=c(2, 2))
hist(resid(m))
qqnorm(resid(m));qqline(resid(m))
plot(fitted(m), resid(m))
```

### Without domino task

```{r, include=FALSE}
load(paste0(here::here(), "/data/speechData-allIPUs.RData"))
ipus <- merge(ipus, 
              read.csv("C:/Users/offredet/Documents/1HU/ExperimentTemperature/Data/dominoTiming.csv", sep=";"),
              by = "dyad", all=TRUE) |> 
  mutate_at(c("dominoOnset", "dominoOffset"), as.numeric) |>  
  mutate(delete = ifelse(
    condition == "impersonal" & grepl("L3", file) & turnOnset > dominoOnset & turnOffset < dominoOffset,
    "del",
    "keep"
  )) |>
  filter(delete == "keep") |> 
  select(-delete) |> 
  group_by(speaker) |> 
  mutate(f0meanz = (f0mean - mean(f0mean, na.rm=TRUE)) / sd(f0mean, na.rm=TRUE),
         f0medz = (f0med - mean(f0med, na.rm=TRUE)) / sd(f0med, na.rm=TRUE),
         f0sdz = (f0sd - mean(f0sd, na.rm=TRUE)) / sd(f0sd, na.rm=TRUE),
         f0maxz = (f0max - mean(f0max, na.rm=TRUE)) / sd(f0max, na.rm=TRUE)) |> 
  ungroup()
```

#### f0 median

-   Only during question lists: f0 median doesn't change in any condition.

```{r}
ggplot(ipus |> filter(task=="Lists"), aes(turnOverall, f0medz))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~condition)+
  ggtitle("Question lists (1st part of experiment)")
summary(m <- lmer(f0medz ~ turnOverall + (1|speaker), ipus |> filter(task=="Lists")))
summary(m1 <- lmer(f0medz ~ turnOverall : condition + (1|speaker), ipus |> filter(task=="Lists")))
anova(m, m1)
par(mfrow=c(2, 2))
hist(resid(m))
qqnorm(resid(m));qqline(resid(m))
plot(fitted(m), resid(m))
```

#### f0 max

-   Only during question lists: f0 max doesn't change in either condition.

```{r}
ggplot(ipus |> filter(task=="Lists"), aes(turnOverall, f0maxz))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~condition)+
  ggtitle("Question lists (1st part of experiment)")
summary(m <- lmer(f0maxz ~ turnOverall + (1|speaker), ipus |> filter(task=="Lists")))
summary(m1 <- lmer(f0maxz ~ turnOverall : condition + (1|speaker), ipus |> filter(task=="Lists")))
anova(m, m1)
par(mfrow=c(2, 2))
hist(resid(m))
qqnorm(resid(m));qqline(resid(m))
plot(fitted(m), resid(m))
```

#### f0 SD

-   Only during question lists: f0 SD decreases in both conditions.

```{r}
ggplot(ipus |> filter(task=="Lists"), aes(turnOverall, f0sdz))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~condition)+
  ggtitle("Question lists (1st part of experiment)")
summary(m <- lmer(f0sdz ~ turnOverall + (1|speaker), ipus |> filter(task=="Lists")))
summary(m1 <- lmer(f0sdz ~ turnOverall : condition + (1|speaker), ipus |> filter(task=="Lists")))
anova(m, m1)
par(mfrow=c(2, 2))
hist(resid(m))
qqnorm(resid(m));qqline(resid(m))
plot(fitted(m), resid(m))
```

### Categorical change (per speaker)

```{r, include=FALSE}
ind <- data.frame(matrix(nrow=0, ncol=6))
names(ind) <- c("speaker", "condition", "feature", "section", "t", "p")

for(s in unique(ipus$speaker)){
  # f0 median
  c <- tidy(lm(f0medz ~ turnOverall, ipus |> filter(speaker==s)))
  ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0median", "entireExp",
                         c$statistic[2], c$p.value[2])
  c <- tidy(lm(f0medz ~ turnOverall, ipus |> filter(speaker==s, task=="Lists")))
  ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0median", "Lists",
                         c$statistic[2], c$p.value[2])
  if(!all(is.na(ipus$f0medz[ipus$speaker==s & ipus$task=="Diapix"]))){ # need to do this because there are missing files for one dyad for this section
    c <- tidy(lm(f0medz ~ turnOverall, ipus |> filter(speaker==s, task=="Diapix")))
    ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0median", "Diapix",
                           c$statistic[2], c$p.value[2])
  }
  
  # f0 max
  c <- tidy(lm(f0maxz ~ turnOverall, ipus |> filter(speaker==s)))
  ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0max", "entireExp",
                         c$statistic[2], c$p.value[2])
  c <- tidy(lm(f0maxz ~ turnOverall, ipus |> filter(speaker==s, task=="Lists")))
  ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0max", "Lists",
                         c$statistic[2], c$p.value[2])
  if(!all(is.na(ipus$f0maxz[ipus$speaker==s & ipus$task=="Diapix"]))){ # need to do this because there are missing files for one dyad for this section
    c <- tidy(lm(f0maxz ~ turnOverall, ipus |> filter(speaker==s, task=="Diapix")))
    ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0max", "Diapix",
                           c$statistic[2], c$p.value[2])
  }
  
  # f0 SD
  c <- tidy(lm(f0sdz ~ turnOverall, ipus |> filter(speaker==s)))
  ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0SD", "entireExp",
                         c$statistic[2], c$p.value[2])
  c <- tidy(lm(f0sdz ~ turnOverall, ipus |> filter(speaker==s, task=="Lists")))
  ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0SD", "Lists",
                         c$statistic[2], c$p.value[2])
  if(!all(is.na(ipus$f0sdz[ipus$speaker==s & ipus$task=="Diapix"]))){ # need to do this because there are missing files for one dyad for this section
    c <- tidy(lm(f0sdz ~ turnOverall, ipus |> filter(speaker==s, task=="Diapix")))
    ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0SD", "Diapix",
                           c$statistic[2], c$p.value[2])
  }
}

dat <- merge(ind |> 
               mutate_at(c("t", "p"), as.numeric) |> 
               mutate(change = case_when(
                 p < 0.05 & t < 0 ~ "decrease",
                 p < 0.05 & t > 0 ~ "increase",
                 p > 0.05 ~ "ns"
               )),
             ipus |> select(speaker, gender, comfortPre, comfortPost, closeness, similarity, likeability, becomeFriends, extraversion, openness, agreeableness, conscientiousness, neuroticism) |> filter(!duplicated(speaker)),
             by = "speaker") |> 
  mutate_at(c("speaker", "condition", "feature", "section", "change", "gender"), as.factor)

dat$change <- relevel(dat$change, ref="ns")

# join individual temperature change effects
indTemp <- indTemp |> 
  mutate(effect = case_when(
    effect == "ns" ~ "tempNS",
    effect == "increase" ~ "tempIncrease",
    effect == "decrease" ~ "tempDecrease",
  ))

s <- dat |> 
  mutate(change = case_when(
    change == "ns" ~ "f0NS",
    change == "increase" ~ "f0Increase",
    change == "decrease" ~ "f0Decrease",
  ))

t1 <- indTemp |> 
  filter(section=="entireExp") |> 
  group_by(speaker) |>
  pivot_wider(names_from = ROI, values_from = effect, id_cols=speaker) |> 
  mutate(section = "entireExp")

t2 <- indTemp |> 
  filter(section=="Lists") |> 
  group_by(speaker) |>
  pivot_wider(names_from = ROI, values_from = effect, id_cols=speaker) |> 
  mutate(section = "Lists")

t3 <- indTemp |> 
  filter(section=="Diapix") |> 
  group_by(speaker) |>
  pivot_wider(names_from = ROI, values_from = effect, id_cols=speaker) |> 
  mutate(section = "Diapix")
# mutate(section = "Lists") # naming the Diapix section and "Lists" to pair these values with the f0 adaptation during "Lists", since temperature change takes a while to happen
# this didn't bring about any new insights

t <- rbind(t1, rbind(t2, t3))
# t <- rbind(t1, t3)

ts <- merge(t,
            s |> 
              select(-condition),
            by=c("speaker", "section"), all=TRUE) |> 
  mutate_at(c("speaker", "section", "Forehead", "Eyes", "Nose", "Cheeks", "feature", "change", "gender"), as.factor)

ts$Forehead <- relevel(ts$Forehead, ref="tempNS")
ts$Cheeks <- relevel(ts$Cheeks, ref="tempNS")
ts$Eyes <- relevel(ts$Eyes, ref="tempNS")
ts$Nose <- relevel(ts$Nose, ref="tempNS")
ts$change <- relevel(ts$change, ref="f0NS")
```

#### f0 median

No significant effects

#### f0 max

f0 max decreased *less* when the speaker felt *closer* to their partner.
```{r}
ggplot(dat |> filter(feature=="f0max", section=="Lists"), aes(change, closeness))+
  geom_boxplot()
```

```{r}
tidy(m <- nnet::multinom(change ~ closeness, data=dat |> filter(feature=="f0max", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
```

f0 max also decreased *less* (smaller effect) when the speaker *liked* their partner *more*.
```{r}
ggplot(dat |> filter(feature=="f0max", section=="Lists"), aes(change, likeability))+
  geom_boxplot()
```

```{r}
tidy(m <- nnet::multinom(change ~ likeability, data=dat |> filter(feature=="f0max", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
```

#### f0 SD

No significant effects

## Convergence
(following Levitan & Hirschberg 2011's method)

```{r, include=FALSE}
load(paste0(here::here(), "/data/speechData.RData"))

all <- data.frame(matrix(nrow=0, ncol=9))
names(all) <- c("speaker", "type", "direction", "coefficient", "mock", "real", "condition", "feature", "section")
```

```{r}
ggplot(dat |> filter(task=="Lists"), aes(turnOverall, f0medDiff))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~speaker)
```

```{r, include=FALSE}
corS <- data.frame(matrix(nrow=0, ncol=4))
names(corS) <- c("speaker", "type", "r", "p")

for(s in unique(dat$speaker)){
  d <- dat |> filter(speaker==s, task=="Lists")
  c <- cor.test(d$f0medDiff, d$turnOverall,
                alternative="two.sided", method="pearson")
  corS[nrow(corS)+1,] <- c(s, "real", c$estimate, c$p.value)
  
  for(i in 1:10){
    c <- cor.test(d[,paste0("mockMedDiff", i)], d$turnOverall,
                  alternative="two.sided", method="pearson")
    corS[nrow(corS)+1,] <- c(s, "mock", c$estimate, c$p.value)
  }
}

corS <- corS |> 
  mutate(sign = ifelse(p < 0.05, "*", NA),
         direction = case_when(
           r < 0 ~ "convergence",
           r > 0 ~ "divergence"))

count <- data.frame(matrix(nrow=0, ncol=6))
names(count) <- c("speaker", "type", "direction", "coefficient", "mock", "real")

for(s in unique(corS$speaker)){
  count[nrow(count)+1,] <- c(s,
                             "convergence",
                             corS$direction[corS$speaker==s & corS$type=="real"],
                             corS$r[corS$speaker==s & corS$type=="real"],
                             sum(!is.na(corS$sign[corS$speaker==s & corS$type=="mock"])==TRUE),
                             ifelse(corS$sign[corS$speaker==s & corS$type=="real"]=="*", "yes", "no"))
}

count <- merge(count, dat |> select(condition, speaker) |> filter(!duplicated(speaker)), by ="speaker")

count <- count |>
  mutate_at("mock", as.numeric) |> 
  arrange(mock) |> 
  mutate(feature = "f0median",
         section = "Lists",
         real = case_when(
           mock > 1 | is.na(real) ~ "no",
           .default = as.character(real)
         ))

all <- rbind(all, count)
```

```{r}
ggplot(dat |> filter(task=="Lists"), aes(turnOverall, f0maxDiff))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~speaker)
```

```{r, include=FALSE}
corS <- data.frame(matrix(nrow=0, ncol=4))
names(corS) <- c("speaker", "type", "r", "p")

for(s in unique(dat$speaker)){
  d <- dat |> filter(speaker==s, task=="Lists")
  c <- cor.test(d$f0maxDiff, d$turnOverall,
                alternative="two.sided", method="pearson")
  corS[nrow(corS)+1,] <- c(s, "real", c$estimate, c$p.value)
  
  for(i in 1:10){
    c <- cor.test(d[,paste0("mockMaxDiff", i)], d$turnOverall,
                  alternative="two.sided", method="pearson")
    corS[nrow(corS)+1,] <- c(s, "mock", c$estimate, c$p.value)
  }
}

corS <- corS |> 
  mutate(sign = ifelse(p < 0.05, "*", NA),
         direction = case_when(
           r < 0 ~ "convergence",
           r > 0 ~ "divergence"))

count <- data.frame(matrix(nrow=0, ncol=6))
names(count) <- c("speaker", "type", "direction", "coefficient", "mock", "real")

for(s in unique(corS$speaker)){
  count[nrow(count)+1,] <- c(s,
                             "convergence",
                             corS$direction[corS$speaker==s & corS$type=="real"],
                             corS$r[corS$speaker==s & corS$type=="real"],
                             sum(!is.na(corS$sign[corS$speaker==s & corS$type=="mock"])==TRUE),
                             ifelse(corS$sign[corS$speaker==s & corS$type=="real"]=="*", "yes", "no"))
}

count <- merge(count, dat |> select(condition, speaker) |> filter(!duplicated(speaker)), by ="speaker")

count <- count |>
  mutate_at("mock", as.numeric) |> 
  arrange(mock) |> 
  mutate(feature = "f0max",
         section = "Lists",
         real = case_when(
           mock > 1 | is.na(real) ~ "no",
           .default = as.character(real)
         ))

all <- rbind(all, count)
```

```{r}
ggplot(dat |> filter(task=="Lists"), aes(turnOverall, f0sdDiff))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~speaker)
```

```{r, include=FALSE}
corS <- data.frame(matrix(nrow=0, ncol=4))
names(corS) <- c("speaker", "type", "r", "p")

for(s in unique(dat$speaker)){
  d <- dat |> filter(speaker==s, task=="Lists")
  c <- cor.test(d$f0sdDiff, d$turnOverall,
                alternative="two.sided", method="pearson")
  corS[nrow(corS)+1,] <- c(s, "real", c$estimate, c$p.value)
  
  for(i in 1:10){
    c <- cor.test(d[,paste0("mockSdDiff", i)], d$turnOverall,
                  alternative="two.sided", method="pearson")
    corS[nrow(corS)+1,] <- c(s, "mock", c$estimate, c$p.value)
  }
}

corS <- corS |> 
  mutate(sign = ifelse(p < 0.05, "*", NA),
         direction = case_when(
           r < 0 ~ "convergence",
           r > 0 ~ "divergence"))

count <- data.frame(matrix(nrow=0, ncol=6))
names(count) <- c("speaker", "type", "direction", "coefficient", "mock", "real")

for(s in unique(corS$speaker)){
  count[nrow(count)+1,] <- c(s,
                             "convergence",
                             corS$direction[corS$speaker==s & corS$type=="real"],
                             corS$r[corS$speaker==s & corS$type=="real"],
                             sum(!is.na(corS$sign[corS$speaker==s & corS$type=="mock"])==TRUE),
                             ifelse(corS$sign[corS$speaker==s & corS$type=="real"]=="*", "yes", "no"))
}

count <- merge(count, dat |> select(condition, speaker) |> filter(!duplicated(speaker)), by ="speaker")

count <- count |>
  mutate_at("mock", as.numeric) |> 
  arrange(mock) |> 
  mutate(feature = "f0sd",
         section = "Lists",
         real = case_when(
           mock > 1 | is.na(real) ~ "no",
           .default = as.character(real)
         ))

all <- rbind(all, count)
```

```{r}
all <- all |> 
  mutate(sectionN = case_when(
    section=="entireExp" ~ 1,
    section=="Lists" ~ 2,
    section=="Diapix" ~ 3
  )) |> 
  rename(entrain=real) |> 
  arrange(sectionN) |> 
  select(-sectionN)
print(all |> filter(entrain=="yes"))
```

# TEMPERATURE ANALYSIS

```{r, include=FALSE}
load(paste0(here::here(), "/data/tempData.RData"))
load(paste0(here::here(), "/data/tempDataChange.RData"))
```

```{r, include=FALSE}
all <- data.frame(matrix(nrow=0, ncol=7))
names(all) <- c("speaker", "condition", "ROI", "direction", "t", "p", "section")

for(s in unique(dat$speaker)){
  for(r in unique(dat$ROI)){
    d <- dat |> filter(speaker==s, ROI==r)
    if(nrow(d)<=1){next}
    c <- tidy(lm(temperature ~ time, d))
    all[nrow(all)+1,] <- c(s, unique(d$condition), r,
                           ifelse(c$estimate[2] < 0, "negative", "positive"),
                           c$statistic[2],
                           c$p.value[2],
                           "entireExp")
    for(section in c("Lists", "Diapix")){
      d <- dat |> filter(speaker==s, ROI==r, task==section)
      if(nrow(d)==0){next}
      c <- tidy(lm(temperature ~ time, d))
      all[nrow(all)+1,] <- c(s, unique(d$condition), r,
                             ifelse(c$estimate[2] < 0, "negative", "positive"),
                             c$statistic[2],
                             c$p.value[2],
                             section)
    }
  }
}

all <- all |> 
  mutate_at(c("t", "p"), as.numeric) |> 
  mutate(sign = ifelse(p < 0.05, "yes", "ns"),
         effect = case_when(
           sign == "yes" & direction == "positive" ~ "increase",
           sign == "yes" & direction == "negative" ~ "decrease",
           sign == "ns" ~ "ns",
         )) |> 
  mutate_at(c("direction", "speaker", "effect", "condition", "section", "ROI"), as.factor)

all$section <- factor(all$section, levels=c("Lists", "Diapix", "entireExp"))
all$effect <- relevel(all$effect, ref="ns")
```

#### First part of experiment (Lists)

```{r, include=FALSE}
d <- merge(all |> 
             filter(section == "Lists") |>
             select(-condition) |> 
             mutate_at(c("sign", "effect"), as.factor),
           meta, by="speaker") |> 
  mutate_at("condition", as.factor)

# data set for poisson regression

dt <- d |> 
  group_by(effect, condition, ROI) |> 
  summarize(count = n()) |> 
  right_join(crossing(effect = unique(d$effect), condition = unique(d$condition), ROI = unique(d$ROI))) |> 
  mutate(count = replace_na(count, 0))
conditionCount <- d |> 
  group_by(condition, ROI) |> 
  summarize(condCount = n())
dt <- merge(dt, conditionCount, by=c("condition", "ROI"))

dt$effect <- relevel(dt$effect, ref="ns")
# contrasts(dt$condition) <- c(-.5,+.5)
dt$condition <- relevel(dt$condition, ref="close")
```

##### Nose

People *increased* their temperature *more often* when they wanted more to *become friends* with their partner. When performing pairwise comparison and adjusting the p value, it became a little over .05 (i.e. .055)
```{r}
ggplot(d |> filter(ROI=="Nose"), aes(effect, becomeFriends))+
  geom_boxplot()
```

```{r}
tidy(m <- nnet::multinom(effect ~ becomeFriends, data=d |> filter(ROI=="Nose"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
```

##### Eyes

No significant effects

##### Forehead

No significant effects

##### Cheeks
No significant effects

#### Second part of experiment (Diapix)

```{r, include=FALSE}
d <- merge(all |> 
             filter(section == "Diapix") |>
             select(-condition) |> 
             mutate_at(c("sign", "effect"), as.factor),
           meta, by="speaker") |> 
  mutate_at("condition", as.factor)

# data set for poisson regression

dt <- d |> 
  group_by(effect, condition, ROI) |> 
  summarize(count = n()) |> 
  right_join(crossing(effect = unique(d$effect), condition = unique(d$condition), ROI = unique(d$ROI))) |> 
  mutate(count = replace_na(count, 0))
conditionCount <- d |> 
  group_by(condition, ROI) |> 
  summarize(condCount = n())
dt <- merge(dt, conditionCount, by=c("condition", "ROI"))

dt$effect <- relevel(dt$effect, ref="ns")
# contrasts(dt$condition) <- c(-.5,+.5)
dt$condition <- relevel(dt$condition, ref="close")
```

##### Nose

People *decrease* their temperature *more often* when they wanted more to *become friends* with their partner.
```{r}
ggplot(d |> filter(ROI=="Nose"), aes(effect, becomeFriends))+
  geom_boxplot()
```

```{r}
tidy(m <- nnet::multinom(effect ~ becomeFriends, data=d |> filter(ROI=="Nose"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
```

##### Eyes

Eye temperature *increased less often* when the speaker felt *closer* to their partner.
```{r}
ggplot(d |> filter(ROI=="Eyes"), aes(effect, likeability))+
  geom_boxplot()
```

```{r}
tidy(m <- nnet::multinom(effect ~ closeness, data=d |> filter(ROI=="Eyes"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
```

##### Forehead

```{r}
ggplot(d |> filter(ROI=="Forehead"), aes(condition, fill=effect))+
  geom_bar()+
  ggtitle("FOREHEAD: Temperature change across conditions (Diapix)")+
  scale_fill_manual(values = c("decrease" = "lightblue", "increase" = "red", "ns" = "gray"))
```

More increases in *impersonal*, but adjusted p value = 0.07
```{r}
tidy(m <- nnet::multinom(effect ~ condition, data=d |> filter(ROI=="Forehead"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
emmeans(m, pairwise~condition, by="effect")
summary(glmer(sign ~ condition + (1|speaker), d |> filter(ROI=="Forehead"), family=binomial))
```

Forehead temperature *increased less often* when the speaker *liked* their partner *more*.
```{r}
ggplot(d |> filter(ROI=="Forehead"), aes(effect, likeability))+
  geom_boxplot()
```

```{r}
tidy(m <- nnet::multinom(effect ~ likeability, data=d |> filter(ROI=="Forehead"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
```

##### Cheeks

```{r}
ggplot(d |> filter(ROI=="Cheeks"), aes(condition, fill=effect))+
  geom_bar()+
  ggtitle("CHEEKS: Temperature change across conditions (Diapix)")+
  scale_fill_manual(values = c("decrease" = "lightblue", "increase" = "red", "ns" = "gray"))
```

Cheek temperature tended to *increase more often* in the *impersonal* condition, but the adjusted p value was slightly above 0.05 (i.e., 0.053).
```{r}
tidy(m <- nnet::multinom(effect ~ condition, data=d |> filter(ROI=="Cheeks"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
emmeans(m, pairwise~condition, by="effect")
```

# ONLY NULL FINDINGS

# SPEECH ANALYSIS

```{r include=FALSE}
library(tidyverse)
library(lmerTest)
library(DHARMa)
library(broom)
library(parsnip)
library(nnet)
library(emmeans)

load(paste0(here::here(), "/data/speechData.RData"))
load(paste0(here::here(), "/data/speechData-allIPUs.RData"))
load(paste0(here::here(), "/data/individualTemp.RData"))
load(paste0(here::here(), "/data/metadata-clean.RData"))
meta <- m
```

## Speech adaptation (regardless of interlocutor)

### Numerical measure (all speakers together)

#### f0 median

-   Only during question lists: f0 median doesn't change in any condition.

```{r, include=FALSE}
load(paste0(here::here(), "/data/speechData-allIPUs.RData"))
# ipus <- ipus |> 
#   filter(gender != "Male")
```

```{r}
ggplot(ipus |> filter(task=="Lists"), aes(turnOverall, f0medz))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~condition)+
  ggtitle("Question lists (1st part of experiment)")
summary(m <- lmer(f0medz ~ turnOverall + (1|speaker), ipus |> filter(task=="Lists")))
par(mfrow=c(2, 2))
hist(resid(m))
qqnorm(resid(m));qqline(resid(m))
plot(fitted(m), resid(m))
```

#### f0 max

Significant effect (in first section above)

#### f0 SD

Significant effect (in first section above)

### Categorical change (per speaker)

```{r, include=FALSE}
ind <- data.frame(matrix(nrow=0, ncol=6))
names(ind) <- c("speaker", "condition", "feature", "section", "t", "p")

for(s in unique(ipus$speaker)){
  # f0 median
  c <- tidy(lm(f0medz ~ turnOverall, ipus |> filter(speaker==s)))
  ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0median", "entireExp",
                         c$statistic[2], c$p.value[2])
  c <- tidy(lm(f0medz ~ turnOverall, ipus |> filter(speaker==s, task=="Lists")))
  ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0median", "Lists",
                         c$statistic[2], c$p.value[2])
  if(!all(is.na(ipus$f0medz[ipus$speaker==s & ipus$task=="Diapix"]))){ # need to do this because there are missing files for one dyad for this section
    c <- tidy(lm(f0medz ~ turnOverall, ipus |> filter(speaker==s, task=="Diapix")))
    ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0median", "Diapix",
                           c$statistic[2], c$p.value[2])
  }
  
  # f0 max
  c <- tidy(lm(f0maxz ~ turnOverall, ipus |> filter(speaker==s)))
  ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0max", "entireExp",
                         c$statistic[2], c$p.value[2])
  c <- tidy(lm(f0maxz ~ turnOverall, ipus |> filter(speaker==s, task=="Lists")))
  ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0max", "Lists",
                         c$statistic[2], c$p.value[2])
  if(!all(is.na(ipus$f0maxz[ipus$speaker==s & ipus$task=="Diapix"]))){ # need to do this because there are missing files for one dyad for this section
    c <- tidy(lm(f0maxz ~ turnOverall, ipus |> filter(speaker==s, task=="Diapix")))
    ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0max", "Diapix",
                           c$statistic[2], c$p.value[2])
  }
  
  # f0 SD
  c <- tidy(lm(f0sdz ~ turnOverall, ipus |> filter(speaker==s)))
  ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0SD", "entireExp",
                         c$statistic[2], c$p.value[2])
  c <- tidy(lm(f0sdz ~ turnOverall, ipus |> filter(speaker==s, task=="Lists")))
  ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0SD", "Lists",
                         c$statistic[2], c$p.value[2])
  if(!all(is.na(ipus$f0sdz[ipus$speaker==s & ipus$task=="Diapix"]))){ # need to do this because there are missing files for one dyad for this section
    c <- tidy(lm(f0sdz ~ turnOverall, ipus |> filter(speaker==s, task=="Diapix")))
    ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0SD", "Diapix",
                           c$statistic[2], c$p.value[2])
  }
}

dat <- merge(ind |> 
               mutate_at(c("t", "p"), as.numeric) |> 
               mutate(change = case_when(
                 p < 0.05 & t < 0 ~ "decrease",
                 p < 0.05 & t > 0 ~ "increase",
                 p > 0.05 ~ "ns"
               )),
             ipus |> select(speaker, gender, comfortPre, comfortPost, closeness, similarity, likeability, becomeFriends, extraversion, openness, agreeableness, conscientiousness, neuroticism) |> filter(!duplicated(speaker)),
             by = "speaker") |> 
  mutate_at(c("speaker", "condition", "feature", "section", "change", "gender"), as.factor)

dat$change <- relevel(dat$change, ref="ns")

# join individual temperature change effects
indTemp <- indTemp |> 
  mutate(effect = case_when(
    effect == "ns" ~ "tempNS",
    effect == "increase" ~ "tempIncrease",
    effect == "decrease" ~ "tempDecrease",
  ))

s <- dat |> 
  mutate(change = case_when(
    change == "ns" ~ "f0NS",
    change == "increase" ~ "f0Increase",
    change == "decrease" ~ "f0Decrease",
  ))

t1 <- indTemp |> 
  filter(section=="entireExp") |> 
  group_by(speaker) |>
  pivot_wider(names_from = ROI, values_from = effect, id_cols=speaker) |> 
  mutate(section = "entireExp")

t2 <- indTemp |> 
  filter(section=="Lists") |> 
  group_by(speaker) |>
  pivot_wider(names_from = ROI, values_from = effect, id_cols=speaker) |> 
  mutate(section = "Lists")

t3 <- indTemp |> 
  filter(section=="Diapix") |> 
  group_by(speaker) |>
  pivot_wider(names_from = ROI, values_from = effect, id_cols=speaker) |> 
  mutate(section = "Diapix")
# mutate(section = "Lists") # naming the Diapix section and "Lists" to pair these values with the f0 adaptation during "Lists", since temperature change takes a while to happen
# this didn't bring about any new insights

t <- rbind(t1, rbind(t2, t3))
# t <- rbind(t1, t3)

ts <- merge(t,
            s |> 
              select(-condition),
            by=c("speaker", "section"), all=TRUE) |> 
  mutate_at(c("speaker", "section", "Forehead", "Eyes", "Nose", "Cheeks", "feature", "change", "gender"), as.factor)

ts$Forehead <- relevel(ts$Forehead, ref="tempNS")
ts$Cheeks <- relevel(ts$Cheeks, ref="tempNS")
ts$Eyes <- relevel(ts$Eyes, ref="tempNS")
ts$Nose <- relevel(ts$Nose, ref="tempNS")
ts$change <- relevel(ts$change, ref="f0NS")
```

#### f0 median

No effect of condition

```{r}
ggplot(dat |> filter(feature=="f0median", section=="Lists"), aes(condition, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("decrease" = "lightblue", "increase" = "red", "ns" = "gray"))+
  ggtitle("f0 median (first part of exp - Lists)")
```

```{r}
tidy(m <- nnet::multinom(change ~ condition, data=dat |> filter(feature=="f0median", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
emmeans(m, pairwise~condition, by="change")
```

No effect of perception of partner
```{r}
tidy(m <- nnet::multinom(change ~ closeness, data=dat |> filter(feature=="f0median", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))

tidy(m <- nnet::multinom(change ~ similarity, data=dat |> filter(feature=="f0median", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))

tidy(m <- nnet::multinom(change ~ likeability, data=dat |> filter(feature=="f0median", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))

tidy(m <- nnet::multinom(change ~ becomeFriends, data=dat |> filter(feature=="f0median", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
```

No effect of forehead temperature change on f0 median change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0median", !is.na(Forehead)), aes(Forehead, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Forehead temp. change and f0 median change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Forehead, data=ts |> filter(feature=="f0median", section=="Lists", !is.na(Forehead)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Forehead, by="change")
```

No effect of nose temperature change on f0 median change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0median", !is.na(Nose)), aes(Nose, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Nose temp. change and f0 median change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Nose, data=ts |> filter(feature=="f0median", section=="Lists", !is.na(Nose)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Nose, by="change")
```

No effect of eye temperature change on f0 median change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0median", !is.na(Eyes)), aes(Eyes, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Eye temp. change and f0 median change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Eyes, data=ts |> filter(feature=="f0median", section=="Lists", !is.na(Eyes)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Eyes, by="change") # isn't working (I'm thinking maybe because "eyes" have lots of missing values)
```

No effect of cheek temperature change on f0 median change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0median", , !is.na(Cheeks)), aes(Cheeks, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Cheek temp. change and f0 median change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Cheeks, data=ts |> filter(feature=="f0median", section=="Lists", !is.na(Cheeks)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Cheeks, by="change")
```

#### f0 max

No effect of condition

```{r}
ggplot(dat |> filter(feature=="f0max", section=="Lists"), aes(condition, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("decrease" = "lightblue", "increase" = "red", "ns" = "gray"))+
  ggtitle("f0 max (first part of exp - Lists)")
```

```{r}
tidy(m <- nnet::multinom(change ~ condition, data=dat |> filter(feature=="f0max", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
emmeans(m, pairwise~condition, by="change")
```

The null effects of perception of partner 
```{r}
tidy(m <- nnet::multinom(change ~ similarity, data=dat |> filter(feature=="f0max", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))

tidy(m <- nnet::multinom(change ~ becomeFriends, data=dat |> filter(feature=="f0max", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
```

No effect of forehead temperature change on f0 max change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0max", !is.na(Forehead)), aes(Forehead, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Forehead temp. change and f0 max change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Forehead, data=ts |> filter(feature=="f0max", section=="Lists", !is.na(Forehead)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Forehead, by="change")
```

No effect of nose temperature change on f0 max change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0max", !is.na(Nose)), aes(Nose, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Nose temp. change and f0 max change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Nose, data=ts |> filter(feature=="f0max", section=="Lists", !is.na(Nose)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Nose, by="change")
```

No effect of eye temperature change on f0 max change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0max", !is.na(Eyes)), aes(Eyes, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Eye temp. change and f0 max change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Eyes, data=ts |> filter(feature=="f0max", section=="Lists", !is.na(Eyes)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Eyes, by="change") # isn't working (I'm thinking maybe because "eyes" have lots of missing values)
```

No effect of cheek temperature change on f0 max change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0max", !is.na(Cheeks)), aes(Cheeks, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Cheek temp. change and f0 max change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Cheeks, data=ts |> filter(feature=="f0max", section=="Lists", !is.na(Cheeks)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Cheeks, by="change")
```

#### f0 SD

No effect of condition

```{r}
ggplot(dat |> filter(feature=="f0SD", section=="Lists"), aes(condition, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("decrease" = "lightblue", "increase" = "red", "ns" = "gray"))+
  ggtitle("f0 SD (first part of exp - Lists)")
```

```{r}
tidy(m <- nnet::multinom(change ~ condition, data=dat |> filter(feature=="f0SD", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
emmeans(m, pairwise~condition, by="change")
```

No effect of perception of partner
```{r}
tidy(m <- nnet::multinom(change ~ closeness, data=dat |> filter(feature=="f0SD", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))

tidy(m <- nnet::multinom(change ~ similarity, data=dat |> filter(feature=="f0SD", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))

tidy(m <- nnet::multinom(change ~ likeability, data=dat |> filter(feature=="f0SD", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))

tidy(m <- nnet::multinom(change ~ becomeFriends, data=dat |> filter(feature=="f0SD", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
```

No effect of forehead temperature change on f0 SD change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0SD", !is.na(Forehead)), aes(Forehead, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Forehead temp. change and f0 SD change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Forehead, data=ts |> filter(feature=="f0SD", section=="Lists", !is.na(Forehead)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Forehead, by="change")
```

No effect of nose temperature change on f0 SD change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0SD", !is.na(Nose)), aes(Nose, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Nose temp. change and f0 SD change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Nose, data=ts |> filter(feature=="f0SD", section=="Lists", !is.na(Nose)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Nose, by="change")
```

No effect of eye temperature change on f0 SD change
(The model actually suggests that f0 SD decreased more when the temperature also decreased. But there are so few data points of `temperature decrease` that I don't think this is robust or meaningful.)
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0SD", !is.na(Eyes)), aes(Eyes, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Eye temp. change and f0 SD change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Eyes, data=ts |> filter(feature=="f0SD", section=="Lists", !is.na(Eyes)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Eyes, by="change") # isn't working (I'm thinking maybe because "eyes" have lots of missing values)
```

No effect of cheek temperature change on f0 SD change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0SD", !is.na(Cheeks)), aes(Cheeks, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Cheek temp. change and f0 SD change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Cheeks, data=ts |> filter(feature=="f0SD", section=="Lists", !is.na(Cheeks)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Cheeks, by="change")
```


## Convergence
(following Levitan & Hirschberg 2011's method)

```{r, include=FALSE}
load(paste0(here::here(), "/data/speechData.RData"))

all <- data.frame(matrix(nrow=0, ncol=9))
names(all) <- c("speaker", "type", "direction", "coefficient", "mock", "real", "condition", "feature", "section")
```

```{r}
ggplot(dat |> filter(task=="Lists"), aes(turnOverall, f0medDiff))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~speaker)
```

```{r, include=FALSE}
corS <- data.frame(matrix(nrow=0, ncol=4))
names(corS) <- c("speaker", "type", "r", "p")

for(s in unique(dat$speaker)){
  d <- dat |> filter(speaker==s, task=="Lists")
  c <- cor.test(d$f0medDiff, d$turnOverall,
                alternative="two.sided", method="pearson")
  corS[nrow(corS)+1,] <- c(s, "real", c$estimate, c$p.value)
  
  for(i in 1:10){
    c <- cor.test(d[,paste0("mockMedDiff", i)], d$turnOverall,
                  alternative="two.sided", method="pearson")
    corS[nrow(corS)+1,] <- c(s, "mock", c$estimate, c$p.value)
  }
}

corS <- corS |> 
  mutate(sign = ifelse(p < 0.05, "*", NA),
         direction = case_when(
           r < 0 ~ "convergence",
           r > 0 ~ "divergence"))

count <- data.frame(matrix(nrow=0, ncol=6))
names(count) <- c("speaker", "type", "direction", "coefficient", "mock", "real")

for(s in unique(corS$speaker)){
  count[nrow(count)+1,] <- c(s,
                             "convergence",
                             corS$direction[corS$speaker==s & corS$type=="real"],
                             corS$r[corS$speaker==s & corS$type=="real"],
                             sum(!is.na(corS$sign[corS$speaker==s & corS$type=="mock"])==TRUE),
                             ifelse(corS$sign[corS$speaker==s & corS$type=="real"]=="*", "yes", "no"))
}

count <- merge(count, dat |> select(condition, speaker) |> filter(!duplicated(speaker)), by ="speaker")

count <- count |>
  mutate_at("mock", as.numeric) |> 
  arrange(mock) |> 
  mutate(feature = "f0median",
         section = "Lists",
         real = case_when(
           mock > 1 | is.na(real) ~ "no",
           .default = as.character(real)
         ))

all <- rbind(all, count)
```

```{r}
ggplot(dat |> filter(task=="Lists"), aes(turnOverall, f0maxDiff))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~speaker)
```

```{r, include=FALSE}
corS <- data.frame(matrix(nrow=0, ncol=4))
names(corS) <- c("speaker", "type", "r", "p")

for(s in unique(dat$speaker)){
  d <- dat |> filter(speaker==s, task=="Lists")
  c <- cor.test(d$f0maxDiff, d$turnOverall,
                alternative="two.sided", method="pearson")
  corS[nrow(corS)+1,] <- c(s, "real", c$estimate, c$p.value)
  
  for(i in 1:10){
    c <- cor.test(d[,paste0("mockMaxDiff", i)], d$turnOverall,
                  alternative="two.sided", method="pearson")
    corS[nrow(corS)+1,] <- c(s, "mock", c$estimate, c$p.value)
  }
}

corS <- corS |> 
  mutate(sign = ifelse(p < 0.05, "*", NA),
         direction = case_when(
           r < 0 ~ "convergence",
           r > 0 ~ "divergence"))

count <- data.frame(matrix(nrow=0, ncol=6))
names(count) <- c("speaker", "type", "direction", "coefficient", "mock", "real")

for(s in unique(corS$speaker)){
  count[nrow(count)+1,] <- c(s,
                             "convergence",
                             corS$direction[corS$speaker==s & corS$type=="real"],
                             corS$r[corS$speaker==s & corS$type=="real"],
                             sum(!is.na(corS$sign[corS$speaker==s & corS$type=="mock"])==TRUE),
                             ifelse(corS$sign[corS$speaker==s & corS$type=="real"]=="*", "yes", "no"))
}

count <- merge(count, dat |> select(condition, speaker) |> filter(!duplicated(speaker)), by ="speaker")

count <- count |>
  mutate_at("mock", as.numeric) |> 
  arrange(mock) |> 
  mutate(feature = "f0max",
         section = "Lists",
         real = case_when(
           mock > 1 | is.na(real) ~ "no",
           .default = as.character(real)
         ))

all <- rbind(all, count)
```

```{r}
ggplot(dat |> filter(task=="Lists"), aes(turnOverall, f0sdDiff))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~speaker)
```

```{r, include=FALSE}
corS <- data.frame(matrix(nrow=0, ncol=4))
names(corS) <- c("speaker", "type", "r", "p")

for(s in unique(dat$speaker)){
  d <- dat |> filter(speaker==s, task=="Lists")
  c <- cor.test(d$f0sdDiff, d$turnOverall,
                alternative="two.sided", method="pearson")
  corS[nrow(corS)+1,] <- c(s, "real", c$estimate, c$p.value)
  
  for(i in 1:10){
    c <- cor.test(d[,paste0("mockSdDiff", i)], d$turnOverall,
                  alternative="two.sided", method="pearson")
    corS[nrow(corS)+1,] <- c(s, "mock", c$estimate, c$p.value)
  }
}

corS <- corS |> 
  mutate(sign = ifelse(p < 0.05, "*", NA),
         direction = case_when(
           r < 0 ~ "convergence",
           r > 0 ~ "divergence"))

count <- data.frame(matrix(nrow=0, ncol=6))
names(count) <- c("speaker", "type", "direction", "coefficient", "mock", "real")

for(s in unique(corS$speaker)){
  count[nrow(count)+1,] <- c(s,
                             "convergence",
                             corS$direction[corS$speaker==s & corS$type=="real"],
                             corS$r[corS$speaker==s & corS$type=="real"],
                             sum(!is.na(corS$sign[corS$speaker==s & corS$type=="mock"])==TRUE),
                             ifelse(corS$sign[corS$speaker==s & corS$type=="real"]=="*", "yes", "no"))
}

count <- merge(count, dat |> select(condition, speaker) |> filter(!duplicated(speaker)), by ="speaker")

count <- count |>
  mutate_at("mock", as.numeric) |> 
  arrange(mock) |> 
  mutate(feature = "f0sd",
         section = "Lists",
         real = case_when(
           mock > 1 | is.na(real) ~ "no",
           .default = as.character(real)
         ))

all <- rbind(all, count)
```

```{r}
all <- all |> 
  mutate(sectionN = case_when(
    section=="entireExp" ~ 1,
    section=="Lists" ~ 2,
    section=="Diapix" ~ 3
  )) |> 
  rename(entrain=real) |> 
  arrange(sectionN) |> 
  select(-sectionN)
print(all |> filter(entrain=="yes"))
```

# TEMPERATURE ANALYSIS

```{r, include=FALSE}
load(paste0(here::here(), "/data/tempData.RData"))
load(paste0(here::here(), "/data/tempDataChange.RData"))
```

```{r, include=FALSE}
all <- data.frame(matrix(nrow=0, ncol=7))
names(all) <- c("speaker", "condition", "ROI", "direction", "t", "p", "section")

for(s in unique(dat$speaker)){
  for(r in unique(dat$ROI)){
    d <- dat |> filter(speaker==s, ROI==r)
    if(nrow(d)<=1){next}
    c <- tidy(lm(temperature ~ time, d))
    all[nrow(all)+1,] <- c(s, unique(d$condition), r,
                           ifelse(c$estimate[2] < 0, "negative", "positive"),
                           c$statistic[2],
                           c$p.value[2],
                           "entireExp")
    for(section in c("Lists", "Diapix")){
      d <- dat |> filter(speaker==s, ROI==r, task==section)
      if(nrow(d)==0){next}
      c <- tidy(lm(temperature ~ time, d))
      all[nrow(all)+1,] <- c(s, unique(d$condition), r,
                             ifelse(c$estimate[2] < 0, "negative", "positive"),
                             c$statistic[2],
                             c$p.value[2],
                             section)
    }
  }
}

all <- all |> 
  mutate_at(c("t", "p"), as.numeric) |> 
  mutate(sign = ifelse(p < 0.05, "yes", "ns"),
         effect = case_when(
           sign == "yes" & direction == "positive" ~ "increase",
           sign == "yes" & direction == "negative" ~ "decrease",
           sign == "ns" ~ "ns",
         )) |> 
  mutate_at(c("direction", "speaker", "effect", "condition", "section", "ROI"), as.factor)

all$section <- factor(all$section, levels=c("Lists", "Diapix", "entireExp"))
all$effect <- relevel(all$effect, ref="ns")
```

#### First part of experiment (Lists)

```{r, include=FALSE}
d <- merge(all |> 
             filter(section == "Lists") |>
             select(-condition) |> 
             mutate_at(c("sign", "effect"), as.factor),
           meta, by="speaker") |> 
  mutate_at("condition", as.factor)

# data set for poisson regression

dt <- d |> 
  group_by(effect, condition, ROI) |> 
  summarize(count = n()) |> 
  right_join(crossing(effect = unique(d$effect), condition = unique(d$condition), ROI = unique(d$ROI))) |> 
  mutate(count = replace_na(count, 0))
conditionCount <- d |> 
  group_by(condition, ROI) |> 
  summarize(condCount = n())
dt <- merge(dt, conditionCount, by=c("condition", "ROI"))

dt$effect <- relevel(dt$effect, ref="ns")
# contrasts(dt$condition) <- c(-.5,+.5)
dt$condition <- relevel(dt$condition, ref="close")
```

##### Nose

```{r}
ggplot(d |> filter(ROI=="Nose"), aes(condition, fill=effect))+
  geom_bar()+
  ggtitle("NOSE: Temperature change across conditions (Lists)")+
  scale_fill_manual(values = c("decrease" = "lightblue", "increase" = "red", "ns" = "gray"))
```

No effect of condition
```{r}
tidy(m <- nnet::multinom(effect ~ condition, data=d |> filter(ROI=="Nose"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
emmeans(m, pairwise~condition, by="effect")

summary(glmer(sign ~ condition + (1|speaker), d |> filter(ROI=="Nose"), family=binomial))
```

The null effects of perception of partner
```{r}
tidy(m <- nnet::multinom(effect ~ closeness, data=d |> filter(ROI=="Nose"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ similarity, data=d |> filter(ROI=="Nose"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ likeability, data=d |> filter(ROI=="Nose"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
```

##### Eyes

```{r}
ggplot(d |> filter(ROI=="Eyes"), aes(condition, fill=effect))+
  geom_bar()+
  ggtitle("EYES: Temperature change across conditions (Lists)")+
  scale_fill_manual(values = c("decrease" = "lightblue", "increase" = "red", "ns" = "gray"))
```

No effect of condition
```{r}
tidy(m <- nnet::multinom(effect ~ condition, data=d |> filter(ROI=="Eyes"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
emmeans(m, pairwise~condition, by="effect")

summary(glmer(sign ~ condition + (1|speaker), d |> filter(ROI=="Eyes"), family=binomial))
```

No effect of the perception of their partner.
```{r}
tidy(m <- nnet::multinom(effect ~ becomeFriends, data=d |> filter(ROI=="Eyes"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ closeness, data=d |> filter(ROI=="Eyes"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ similarity, data=d |> filter(ROI=="Eyes"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ likeability, data=d |> filter(ROI=="Eyes"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
```

##### Forehead

```{r}
ggplot(d |> filter(ROI=="Forehead"), aes(condition, fill=effect))+
  geom_bar()+
  ggtitle("FOREHEAD: Temperature change across conditions (Lists)")+
  scale_fill_manual(values = c("decrease" = "lightblue", "increase" = "red", "ns" = "gray"))
```

No effect of condition
```{r}
tidy(m <- nnet::multinom(effect ~ condition, data=d |> filter(ROI=="Forehead"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
emmeans(m, pairwise~condition, by="effect")

summary(glmer(sign ~ condition + (1|speaker), d |> filter(ROI=="Forehead"), family=binomial))
```

No effect of the perception of their partner.
```{r}
tidy(m <- nnet::multinom(effect ~ becomeFriends, data=d |> filter(ROI=="Forehead"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ closeness, data=d |> filter(ROI=="Forehead"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ similarity, data=d |> filter(ROI=="Forehead"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ likeability, data=d |> filter(ROI=="Forehead"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
```

##### Cheeks

```{r}
ggplot(d |> filter(ROI=="Cheeks"), aes(condition, fill=effect))+
  geom_bar()+
  ggtitle("CHEEKS: Temperature change across conditions (Lists)")+
  scale_fill_manual(values = c("decrease" = "lightblue", "increase" = "red", "ns" = "gray"))
```

No effect of condition
```{r}
tidy(m <- nnet::multinom(effect ~ condition, data=d |> filter(ROI=="Cheeks"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
emmeans(m, pairwise~condition, by="effect")

summary(m <- glmer(sign ~ condition + (1|speaker), d |> filter(ROI=="Cheeks"), family=binomial))
```

No effect of the perception of their partner.
```{r}
tidy(m <- nnet::multinom(effect ~ becomeFriends, data=d |> filter(ROI=="Cheeks"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ closeness, data=d |> filter(ROI=="Cheeks"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ similarity, data=d |> filter(ROI=="Cheeks"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ likeability, data=d |> filter(ROI=="Cheeks"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
```

#### Second part of experiment (Diapix)

```{r}
d <- merge(all |> 
             filter(section == "Diapix") |>
             select(-condition) |> 
             mutate_at(c("sign", "effect"), as.factor),
           meta, by="speaker") |> 
  mutate_at("condition", as.factor)
```

```{r}
# data set for poisson regression

dt <- d |> 
  group_by(effect, condition, ROI) |> 
  summarize(count = n()) |> 
  right_join(crossing(effect = unique(d$effect), condition = unique(d$condition), ROI = unique(d$ROI))) |> 
  mutate(count = replace_na(count, 0))
conditionCount <- d |> 
  group_by(condition, ROI) |> 
  summarize(condCount = n())
dt <- merge(dt, conditionCount, by=c("condition", "ROI"))

dt$effect <- relevel(dt$effect, ref="ns")
# contrasts(dt$condition) <- c(-.5,+.5)
dt$condition <- relevel(dt$condition, ref="close")
```

##### Nose

```{r}
ggplot(d |> filter(ROI=="Nose"), aes(condition, fill=effect))+
  geom_bar()+
  ggtitle("NOSE: Temperature change across conditions (Diapix)")+
  scale_fill_manual(values = c("decrease" = "lightblue", "increase" = "red", "ns" = "gray"))
```

No effect of condition
```{r}
tidy(m <- nnet::multinom(effect ~ condition, data=d |> filter(ROI=="Nose"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
emmeans(m, pairwise~condition, by="effect")

summary(glmer(sign ~ condition + (1|speaker), d |> filter(ROI=="Nose"), family=binomial))
```

The null effects of perception of partner
```{r}
tidy(m <- nnet::multinom(effect ~ closeness, data=d |> filter(ROI=="Nose"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ similarity, data=d |> filter(ROI=="Nose"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ likeability, data=d |> filter(ROI=="Nose"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
```

##### Eyes

```{r}
ggplot(d |> filter(ROI=="Eyes"), aes(condition, fill=effect))+
  geom_bar()+
  ggtitle("EYES: Temperature change across conditions (Diapix)")+
  scale_fill_manual(values = c("decrease" = "lightblue", "increase" = "red", "ns" = "gray"))
```

No effect of condition
```{r}
tidy(m <- nnet::multinom(effect ~ condition, data=d |> filter(ROI=="Eyes"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
emmeans(m, pairwise~condition, by="effect")

summary(glmer(sign ~ condition + (1|speaker), d |> filter(ROI=="Eyes"), family=binomial))
```

The null effects of perception of partner
```{r}
tidy(m <- nnet::multinom(effect ~ becomeFriends, data=d |> filter(ROI=="Eyes"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ similarity, data=d |> filter(ROI=="Eyes"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ likeability, data=d |> filter(ROI=="Eyes"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
```

##### Forehead


The null effects of perception of partner
```{r}
tidy(m <- nnet::multinom(effect ~ becomeFriends, data=d |> filter(ROI=="Forehead"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ closeness, data=d |> filter(ROI=="Forehead"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ similarity, data=d |> filter(ROI=="Forehead"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
```

##### Cheeks

No effect of the perception of their partner.
```{r}
tidy(m <- nnet::multinom(effect ~ becomeFriends, data=d |> filter(ROI=="Cheeks"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ closeness, data=d |> filter(ROI=="Cheeks"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ similarity, data=d |> filter(ROI=="Cheeks"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities

tidy(m <- nnet::multinom(effect ~ likeability, data=d |> filter(ROI=="Cheeks"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
```

# Session Info
```{r}
sessionInfo()
```

