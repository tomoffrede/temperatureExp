---
title: "Analysis - Speech Prosody"
author: "Tom Offrede"
date: "2023-11-27"
output: 
  html_document:
    toc: true
    toc_depth: 5
    toc_float: 
      collapsed: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# SPEECH ANALYSIS

```{r include=FALSE}
library(tidyverse)
library(lmerTest)
library(DHARMa)
library(broom)
library(parsnip)
library(nnet)
library(emmeans)

load(paste0(here::here(), "/data/speechData.RData"))
load(paste0(here::here(), "/data/speechData-allIPUs.RData"))
```

## Speech adaptation (regardless of interlocutor)

### Numerical measure (all speakers together)

#### f0 median

-   Across entire experiment: f0 median increases in both conditions.
-   Only during question lists: f0 median doesn't change in any condition.
-   Only during Diapix: f0 median increases in both conditions.

```{r}
load(paste0(here::here(), "/data/speechData-allIPUs.RData"))
# ipus <- ipus |> 
#   filter(gender != "Male")
```

```{r}
ggplot(ipus, aes(turnOverall, f0medz))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~condition)+
  ggtitle("Entire experiment")
summary(m <- lmer(f0medz ~ turnOverall + (1|speaker), ipus))
summary(m1 <- lmer(f0medz ~ turnOverall : condition + (1|speaker), ipus))
anova(m, m1)
par(mfrow=c(2, 2))
hist(resid(m))
qqnorm(resid(m));qqline(resid(m))
plot(fitted(m), resid(m))
```
```{r}
ggplot(ipus |> filter(task=="Lists"), aes(turnOverall, f0medz))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~condition)+
  ggtitle("Question lists (1st part of experiment)")
summary(m <- lmer(f0medz ~ turnOverall + (1|speaker), ipus |> filter(task=="Lists")))
summary(m1 <- lmer(f0medz ~ turnOverall : condition + (1|speaker), ipus |> filter(task=="Lists")))
anova(m, m1)
par(mfrow=c(2, 2))
hist(resid(m))
qqnorm(resid(m));qqline(resid(m))
plot(fitted(m), resid(m))
```
```{r}
ggplot(ipus |> filter(task=="Diapix"), aes(turnOverall, f0medz))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~condition)+
  ggtitle("Diapix (2nd part of experiment)")
summary(m <- lmer(f0medz ~ turnOverall + (1|speaker), ipus |> filter(task=="Diapix")))
summary(m1 <- lmer(f0medz ~ turnOverall : condition + (1|speaker), ipus |> filter(task=="Diapix")))
anova(m, m1)
par(mfrow=c(2, 2))
hist(resid(m))
qqnorm(resid(m));qqline(resid(m))
plot(fitted(m), resid(m))
```

Checking if f0 median changes across time in interaction with questionnaire scores: Even though many of the models are significant, their AIC is not preferred over the model without the questionnaire scores.

```{r}
summary(m <- lmer(f0medz ~ turnOverall + (1|speaker), ipus))
summary(m1 <- lmer(f0medz ~ turnOverall : closeness + (1|speaker), ipus))
summary(m2 <- lmer(f0medz ~ turnOverall : similarity + (1|speaker), ipus))
summary(m3 <- lmer(f0medz ~ turnOverall : likeability + (1|speaker), ipus))
summary(m4 <- lmer(f0medz ~ turnOverall : becomeFriends + (1|speaker), ipus))

anova(m, m1)
anova(m, m2)
anova(m, m3)
anova(m, m4)
```

#### f0 max

-   Across entire experiment: f0 max decreases in both conditions.
-   Only during question lists: f0 max tends to decrease only in the *impersonal* condition, but if we're being strict (AIC of model with `condition` was 1.7 smaller than without), there f0 max went down in both conditions.
-   Only during Diapix: f0 max doesn't change significantly for either group.

```{r}
load(paste0(here::here(), "/data/speechData-allIPUs.RData"))
# ipus <- ipus |>
#   filter(gender != "Male")
```

```{r}
ggplot(ipus, aes(turnOverall, f0maxz))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~condition)+
  ggtitle("Entire experiment")
summary(m <- lm(f0maxz ~ turnOverall, ipus))
summary(m1 <- lm(f0maxz ~ turnOverall : condition, ipus))
anova(m, m1)
par(mfrow=c(2, 2))
hist(resid(m))
qqnorm(resid(m));qqline(resid(m))
plot(fitted(m), resid(m))
```
```{r}
ggplot(ipus |> filter(task=="Lists"), aes(turnOverall, f0maxz))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~condition)+
  ggtitle("Question lists (1st part of experiment)")
summary(m <- lmer(f0maxz ~ turnOverall + (1|speaker), ipus |> filter(task=="Lists")))
summary(m1 <- lmer(f0maxz ~ turnOverall : condition + (1|speaker), ipus |> filter(task=="Lists")))
anova(m, m1)
par(mfrow=c(2, 2))
hist(resid(m))
qqnorm(resid(m));qqline(resid(m))
plot(fitted(m), resid(m))
```
```{r}
ggplot(ipus |> filter(task=="Diapix"), aes(turnOverall, f0maxz))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~condition)+
  ggtitle("Diapix (2nd part of experiment)")
summary(m <- lmer(f0maxz ~ turnOverall + (1|speaker), ipus |> filter(task=="Diapix")))
summary(m1 <- lmer(f0maxz ~ turnOverall : condition + (1|speaker), ipus |> filter(task=="Diapix")))
anova(m, m1)
par(mfrow=c(2, 2))
hist(resid(m))
qqnorm(resid(m));qqline(resid(m))
plot(fitted(m), resid(m))
```

Checking if f0 SD changes across time in interaction with questionnaire scores: Even though many of the models are significant, their AIC is not preferred over the model without the questionnaire scores.

```{r}
summary(m <- lmer(f0maxz ~ turnOverall + (1|speaker), ipus))
summary(m1 <- lmer(f0maxz ~ turnOverall : closeness + (1|speaker), ipus))
summary(m2 <- lmer(f0maxz ~ turnOverall : similarity + (1|speaker), ipus))
summary(m3 <- lmer(f0maxz ~ turnOverall : likeability + (1|speaker), ipus))
summary(m4 <- lmer(f0maxz ~ turnOverall : becomeFriends + (1|speaker), ipus))

anova(m, m1)
anova(m, m2)
anova(m, m3)
anova(m, m4)
```

#### f0 SD

-   Across entire experiment: f0 SD doesn't change in either condition.
-   Only during question lists: f0 SD decreases in both conditions.
-   Only during Diapix: f0 SD doesn't change in either condition.

```{r}
load(paste0(here::here(), "/data/speechData-allIPUs.RData"))
# ipus <- ipus |>
#   filter(gender != "Male")
```

```{r}
ggplot(ipus, aes(turnOverall, f0sdz))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~condition)+
  ggtitle("Entire experiment")
summary(m <- lmer(f0sdz ~ turnOverall + (1|speaker), ipus))
summary(m1 <- lmer(f0sdz ~ turnOverall : condition + (1|speaker), ipus))
anova(m, m1)
par(mfrow=c(2, 2))
hist(resid(m))
qqnorm(resid(m));qqline(resid(m))
plot(fitted(m), resid(m))
```
```{r}
ggplot(ipus |> filter(task=="Lists"), aes(turnOverall, f0sdz))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~condition)+
  ggtitle("Question lists (1st part of experiment)")
summary(m <- lmer(f0sdz ~ turnOverall + (1|speaker), ipus |> filter(task=="Lists")))
summary(m1 <- lmer(f0sdz ~ turnOverall : condition + (1|speaker), ipus |> filter(task=="Lists")))
anova(m, m1)
par(mfrow=c(2, 2))
hist(resid(m))
qqnorm(resid(m));qqline(resid(m))
plot(fitted(m), resid(m))
```
```{r}
ggplot(ipus |> filter(task=="Diapix"), aes(turnOverall, f0sdz))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~condition)+
  ggtitle("Diapix (2nd part of experiment)")
summary(m <- lmer(f0sdz ~ turnOverall + (1|speaker), ipus |> filter(task=="Diapix")))
summary(m1 <- lmer(f0sdz ~ turnOverall : condition + (1|speaker), ipus |> filter(task=="Diapix")))
anova(m, m1)
par(mfrow=c(2, 2))
hist(resid(m))
qqnorm(resid(m));qqline(resid(m))
plot(fitted(m), resid(m))
```

Checking if f0 SD changes across time in interaction with questionnaire scores: Even though many of the models are significant, their AIC is not preferred over the model without the questionnaire scores.

```{r}
summary(m <- lmer(f0sdz ~ turnOverall + (1|speaker), ipus))
summary(m1 <- lmer(f0sdz ~ turnOverall : closeness + (1|speaker), ipus))
summary(m2 <- lmer(f0sdz ~ turnOverall : similarity + (1|speaker), ipus))
summary(m3 <- lmer(f0sdz ~ turnOverall : likeability + (1|speaker), ipus))
summary(m4 <- lmer(f0sdz ~ turnOverall : becomeFriends + (1|speaker), ipus))

anova(m, m1)
anova(m, m2)
anova(m, m3)
anova(m, m4)
```

### Categorical change (per speaker)

```{r}
ind <- data.frame(matrix(nrow=0, ncol=6))
names(ind) <- c("speaker", "condition", "feature", "section", "t", "p")
```

```{r}
for(s in unique(ipus$speaker)){
  # f0 median
  c <- tidy(lm(f0medz ~ turnOverall, ipus |> filter(speaker==s)))
  ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0median", "entireExp",
                         c$statistic[2], c$p.value[2])
  c <- tidy(lm(f0medz ~ turnOverall, ipus |> filter(speaker==s, task=="Lists")))
  ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0median", "Lists",
                         c$statistic[2], c$p.value[2])
  if(!all(is.na(ipus$f0medz[ipus$speaker==s & ipus$task=="Diapix"]))){ # need to do this because there are missing files for one dyad for this section
    c <- tidy(lm(f0medz ~ turnOverall, ipus |> filter(speaker==s, task=="Diapix")))
    ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0median", "Diapix",
                           c$statistic[2], c$p.value[2])
  }
  
  # f0 max
  c <- tidy(lm(f0maxz ~ turnOverall, ipus |> filter(speaker==s)))
  ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0max", "entireExp",
                         c$statistic[2], c$p.value[2])
  c <- tidy(lm(f0maxz ~ turnOverall, ipus |> filter(speaker==s, task=="Lists")))
  ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0max", "Lists",
                         c$statistic[2], c$p.value[2])
  if(!all(is.na(ipus$f0maxz[ipus$speaker==s & ipus$task=="Diapix"]))){ # need to do this because there are missing files for one dyad for this section
    c <- tidy(lm(f0maxz ~ turnOverall, ipus |> filter(speaker==s, task=="Diapix")))
    ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0max", "Diapix",
                           c$statistic[2], c$p.value[2])
  }
  
  # f0 SD
  c <- tidy(lm(f0sdz ~ turnOverall, ipus |> filter(speaker==s)))
  ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0SD", "entireExp",
                         c$statistic[2], c$p.value[2])
  c <- tidy(lm(f0sdz ~ turnOverall, ipus |> filter(speaker==s, task=="Lists")))
  ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0SD", "Lists",
                         c$statistic[2], c$p.value[2])
  if(!all(is.na(ipus$f0sdz[ipus$speaker==s & ipus$task=="Diapix"]))){ # need to do this because there are missing files for one dyad for this section
    c <- tidy(lm(f0sdz ~ turnOverall, ipus |> filter(speaker==s, task=="Diapix")))
    ind[nrow(ind)+1,] <- c(s, unique(ipus$condition[ipus$speaker==s]), "f0SD", "Diapix",
                           c$statistic[2], c$p.value[2])
  }
}

dat <- merge(ind |> 
               mutate_at(c("t", "p"), as.numeric) |> 
               mutate(change = case_when(
                 p < 0.05 & t < 0 ~ "decrease",
                 p < 0.05 & t > 0 ~ "increase",
                 p > 0.05 ~ "ns"
               )),
             ipus |> select(speaker, gender, comfortPre, comfortPost, closeness, similarity, likeability, becomeFriends, extraversion, openness, agreeableness, conscientiousness, neuroticism) |> filter(!duplicated(speaker)),
             by = "speaker") |> 
  mutate_at(c("speaker", "condition", "feature", "section", "change", "gender"), as.factor)

dat$change <- relevel(dat$change, ref="ns")
```

```{r}
# join individual temperature change effects
indTemp <- indTemp |> 
  mutate(effect = case_when(
    effect == "ns" ~ "tempNS",
    effect == "increase" ~ "tempIncrease",
    effect == "decrease" ~ "tempDecrease",
  ))

s <- dat |> 
  mutate(change = case_when(
    change == "ns" ~ "f0NS",
    change == "increase" ~ "f0Increase",
    change == "decrease" ~ "f0Decrease",
  ))

t1 <- indTemp |> 
  filter(section=="entireExp") |> 
  group_by(speaker) |>
  pivot_wider(names_from = ROI, values_from = effect, id_cols=speaker) |> 
  mutate(section = "entireExp")

t2 <- indTemp |> 
  filter(section=="Lists") |> 
  group_by(speaker) |>
  pivot_wider(names_from = ROI, values_from = effect, id_cols=speaker) |> 
  mutate(section = "Lists")

t3 <- indTemp |> 
  filter(section=="Diapix") |> 
  group_by(speaker) |>
  pivot_wider(names_from = ROI, values_from = effect, id_cols=speaker) |> 
  mutate(section = "Diapix")
# mutate(section = "Lists") # naming the Diapix section and "Lists" to pair these values with the f0 adaptation during "Lists", since temperature change takes a while to happen
# this didn't bring about any new insights

t <- rbind(t1, rbind(t2, t3))
# t <- rbind(t1, t3)

ts <- merge(t,
            s |> 
              select(-condition),
            by=c("speaker", "section"), all=TRUE) |> 
  mutate_at(c("speaker", "section", "Forehead", "Eyes", "Nose", "Cheeks", "feature", "change", "gender"), as.factor)

ts$Forehead <- relevel(ts$Forehead, ref="tempNS")
ts$Cheeks <- relevel(ts$Cheeks, ref="tempNS")
ts$Eyes <- relevel(ts$Eyes, ref="tempNS")
ts$Nose <- relevel(ts$Nose, ref="tempNS")
ts$change <- relevel(ts$change, ref="f0NS")
```

#### f0 median

No effect of condition

```{r}
ggplot(dat |> filter(feature=="f0median", section=="Lists"), aes(condition, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("decrease" = "lightblue", "increase" = "red", "ns" = "gray"))+
  ggtitle("f0 median (first part of exp - Lists)")
```

```{r}
tidy(m <- nnet::multinom(change ~ condition, data=dat |> filter(feature=="f0median", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
emmeans(m, pairwise~condition, by="change")
```

No effect of perception of partner
```{r}
tidy(m <- nnet::multinom(change ~ closeness, data=dat |> filter(feature=="f0median", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))

tidy(m <- nnet::multinom(change ~ similarity, data=dat |> filter(feature=="f0median", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))

tidy(m <- nnet::multinom(change ~ likeability, data=dat |> filter(feature=="f0median", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))

tidy(m <- nnet::multinom(change ~ becomeFriends, data=dat |> filter(feature=="f0median", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
```

No effect of forehead temperature change on f0 median change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0median", !is.na(Forehead)), aes(Forehead, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Forehead temp. change and f0 median change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Forehead, data=ts |> filter(feature=="f0median", section=="Lists", !is.na(Forehead)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Forehead, by="change")
```

No effect of nose temperature change on f0 median change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0median", !is.na(Nose)), aes(Nose, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Nose temp. change and f0 median change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Nose, data=ts |> filter(feature=="f0median", section=="Lists", !is.na(Nose)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Nose, by="change")
```

No effect of eye temperature change on f0 median change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0median", !is.na(Eyes)), aes(Eyes, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Eye temp. change and f0 median change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Eyes, data=ts |> filter(feature=="f0median", section=="Lists", !is.na(Eyes)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Eyes, by="change") # isn't working (I'm thinking maybe because "eyes" have lots of missing values)
```

No effect of cheek temperature change on f0 median change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0median", , !is.na(Cheeks)), aes(Cheeks, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Cheek temp. change and f0 median change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Cheeks, data=ts |> filter(feature=="f0median", section=="Lists", !is.na(Cheeks)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Cheeks, by="change")
```

#### f0 max

No effect of condition

```{r}
ggplot(dat |> filter(feature=="f0max", section=="Lists"), aes(condition, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("decrease" = "lightblue", "increase" = "red", "ns" = "gray"))+
  ggtitle("f0 max (first part of exp - Lists)")
```

```{r}
tidy(m <- nnet::multinom(change ~ condition, data=dat |> filter(feature=="f0max", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
emmeans(m, pairwise~condition, by="change")
```

f0 max decreased *less* when the speaker felt *closer* to their partner.
```{r}
ggplot(dat |> filter(feature=="f0max", section=="Lists"), aes(change, closeness))+
  geom_boxplot()
```

```{r}
tidy(m <- nnet::multinom(change ~ closeness, data=dat |> filter(feature=="f0max", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
```

f0 max also decreased *less* (smaller effect) when the speaker *liked* their partner *more*.
```{r}
ggplot(dat |> filter(feature=="f0max", section=="Lists"), aes(change, likeability))+
  geom_boxplot()
```

```{r}
tidy(m <- nnet::multinom(change ~ likeability, data=dat |> filter(feature=="f0max", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))

tidy(m <- nnet::multinom(change ~ similarity, data=dat |> filter(feature=="f0max", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))

tidy(m <- nnet::multinom(change ~ becomeFriends, data=dat |> filter(feature=="f0max", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
```

No effect of forehead temperature change on f0 max change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0max", !is.na(Forehead)), aes(Forehead, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Forehead temp. change and f0 max change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Forehead, data=ts |> filter(feature=="f0max", section=="Lists", !is.na(Forehead)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Forehead, by="change")
```

No effect of nose temperature change on f0 max change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0max", !is.na(Nose)), aes(Nose, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Nose temp. change and f0 max change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Nose, data=ts |> filter(feature=="f0max", section=="Lists", !is.na(Nose)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Nose, by="change")
```

No effect of eye temperature change on f0 max change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0max", !is.na(Eyes)), aes(Eyes, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Eye temp. change and f0 max change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Eyes, data=ts |> filter(feature=="f0max", section=="Lists", !is.na(Eyes)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Eyes, by="change") # isn't working (I'm thinking maybe because "eyes" have lots of missing values)
```

No effect of cheek temperature change on f0 max change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0max", !is.na(Cheeks)), aes(Cheeks, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Cheek temp. change and f0 max change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Cheeks, data=ts |> filter(feature=="f0max", section=="Lists", !is.na(Cheeks)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Cheeks, by="change")
```

#### f0 SD

No effect of condition

```{r}
ggplot(dat |> filter(feature=="f0SD", section=="Lists"), aes(condition, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("decrease" = "lightblue", "increase" = "red", "ns" = "gray"))+
  ggtitle("f0 SD (first part of exp - Lists)")
```

```{r}
tidy(m <- nnet::multinom(change ~ condition, data=dat |> filter(feature=="f0SD", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate)) # plogis transforms log odds (the output of the model) into probabilities
emmeans(m, pairwise~condition, by="change")
```

No effect of perception of partner
```{r}
tidy(m <- nnet::multinom(change ~ closeness, data=dat |> filter(feature=="f0SD", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))

tidy(m <- nnet::multinom(change ~ similarity, data=dat |> filter(feature=="f0SD", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))

tidy(m <- nnet::multinom(change ~ likeability, data=dat |> filter(feature=="f0SD", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))

tidy(m <- nnet::multinom(change ~ becomeFriends, data=dat |> filter(feature=="f0SD", section=="Lists"))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
```

No effect of forehead temperature change on f0 SD change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0SD", !is.na(Forehead)), aes(Forehead, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Forehead temp. change and f0 SD change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Forehead, data=ts |> filter(feature=="f0SD", section=="Lists", !is.na(Forehead)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Forehead, by="change")
```

No effect of nose temperature change on f0 SD change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0SD", !is.na(Nose)), aes(Nose, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Nose temp. change and f0 SD change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Nose, data=ts |> filter(feature=="f0SD", section=="Lists", !is.na(Nose)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Nose, by="change")
```

No effect of eye temperature change on f0 SD change
(The model actually suggests that f0 SD decreased more when the temperature also decreased. But there are so few data points of `temperature decrease` that I don't think this is robust or meaningful.)
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0SD", !is.na(Eyes)), aes(Eyes, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Eye temp. change and f0 SD change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Eyes, data=ts |> filter(feature=="f0SD", section=="Lists", !is.na(Eyes)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Eyes, by="change") # isn't working (I'm thinking maybe because "eyes" have lots of missing values)
```

No effect of cheek temperature change on f0 SD change
```{r}
ggplot(ts |> filter(section=="Lists", feature=="f0SD", !is.na(Cheeks)), aes(Cheeks, fill=change))+
  geom_bar()+
  scale_fill_manual(values = c("f0Decrease" = "lightblue", "f0Increase" = "red", "f0NS" = "gray"))+
  ggtitle("Cheek temp. change and f0 SD change")
```

```{r}
tidy(m <- nnet::multinom(change ~ Cheeks, data=ts |> filter(feature=="f0SD", section=="Lists", !is.na(Cheeks)))) |> 
  as_tibble() |> 
  mutate(estimate = plogis(estimate))
emmeans(m, pairwise~Cheeks, by="change")
```


## Convergence
(following Levitan & Hirschberg 2011's method)

```{r}
load(paste0(here::here(), "/data/speechData.RData"))

all <- data.frame(matrix(nrow=0, ncol=9))
names(all) <- c("speaker", "type", "direction", "coefficient", "mock", "real", "condition", "feature", "section")
```

```{r}
ggplot(dat |> filter(task=="Lists"), aes(turnOverall, f0medDiff))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~speaker)
```

```{r}
corS <- data.frame(matrix(nrow=0, ncol=4))
names(corS) <- c("speaker", "type", "r", "p")

for(s in unique(dat$speaker)){
  d <- dat |> filter(speaker==s, task=="Lists")
  c <- cor.test(d$f0medDiff, d$turnOverall,
                alternative="two.sided", method="pearson")
  corS[nrow(corS)+1,] <- c(s, "real", c$estimate, c$p.value)
  
  for(i in 1:10){
    c <- cor.test(d[,paste0("mockMedDiff", i)], d$turnOverall,
                  alternative="two.sided", method="pearson")
    corS[nrow(corS)+1,] <- c(s, "mock", c$estimate, c$p.value)
  }
}

corS <- corS |> 
  mutate(sign = ifelse(p < 0.05, "*", NA),
         direction = case_when(
           r < 0 ~ "convergence",
           r > 0 ~ "divergence"))

count <- data.frame(matrix(nrow=0, ncol=6))
names(count) <- c("speaker", "type", "direction", "coefficient", "mock", "real")

for(s in unique(corS$speaker)){
  count[nrow(count)+1,] <- c(s,
                             "convergence",
                             corS$direction[corS$speaker==s & corS$type=="real"],
                             corS$r[corS$speaker==s & corS$type=="real"],
                             sum(!is.na(corS$sign[corS$speaker==s & corS$type=="mock"])==TRUE),
                             ifelse(corS$sign[corS$speaker==s & corS$type=="real"]=="*", "yes", "no"))
}

count <- merge(count, dat |> select(condition, speaker) |> filter(!duplicated(speaker)), by ="speaker")

count <- count |>
  mutate_at("mock", as.numeric) |> 
  arrange(mock) |> 
  mutate(feature = "f0median",
         section = "Lists",
         real = case_when(
           mock > 1 | is.na(real) ~ "no",
           .default = as.character(real)
         ))

all <- rbind(all, count)
```

```{r}
ggplot(dat |> filter(task=="Lists"), aes(turnOverall, f0maxDiff))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~speaker)
```

```{r}
corS <- data.frame(matrix(nrow=0, ncol=4))
names(corS) <- c("speaker", "type", "r", "p")

for(s in unique(dat$speaker)){
  d <- dat |> filter(speaker==s, task=="Lists")
  c <- cor.test(d$f0maxDiff, d$turnOverall,
                alternative="two.sided", method="pearson")
  corS[nrow(corS)+1,] <- c(s, "real", c$estimate, c$p.value)
  
  for(i in 1:10){
    c <- cor.test(d[,paste0("mockMaxDiff", i)], d$turnOverall,
                  alternative="two.sided", method="pearson")
    corS[nrow(corS)+1,] <- c(s, "mock", c$estimate, c$p.value)
  }
}

corS <- corS |> 
  mutate(sign = ifelse(p < 0.05, "*", NA),
         direction = case_when(
           r < 0 ~ "convergence",
           r > 0 ~ "divergence"))

count <- data.frame(matrix(nrow=0, ncol=6))
names(count) <- c("speaker", "type", "direction", "coefficient", "mock", "real")

for(s in unique(corS$speaker)){
  count[nrow(count)+1,] <- c(s,
                             "convergence",
                             corS$direction[corS$speaker==s & corS$type=="real"],
                             corS$r[corS$speaker==s & corS$type=="real"],
                             sum(!is.na(corS$sign[corS$speaker==s & corS$type=="mock"])==TRUE),
                             ifelse(corS$sign[corS$speaker==s & corS$type=="real"]=="*", "yes", "no"))
}

count <- merge(count, dat |> select(condition, speaker) |> filter(!duplicated(speaker)), by ="speaker")

count <- count |>
  mutate_at("mock", as.numeric) |> 
  arrange(mock) |> 
  mutate(feature = "f0max",
         section = "Lists",
         real = case_when(
           mock > 1 | is.na(real) ~ "no",
           .default = as.character(real)
         ))

all <- rbind(all, count)
```

```{r}
ggplot(dat |> filter(task=="Lists"), aes(turnOverall, f0sdDiff))+
  geom_point()+
  geom_smooth(method="lm")+
  facet_wrap(~speaker)
```

```{r}
corS <- data.frame(matrix(nrow=0, ncol=4))
names(corS) <- c("speaker", "type", "r", "p")

for(s in unique(dat$speaker)){
  d <- dat |> filter(speaker==s, task=="Lists")
  c <- cor.test(d$f0sdDiff, d$turnOverall,
                alternative="two.sided", method="pearson")
  corS[nrow(corS)+1,] <- c(s, "real", c$estimate, c$p.value)
  
  for(i in 1:10){
    c <- cor.test(d[,paste0("mockSdDiff", i)], d$turnOverall,
                  alternative="two.sided", method="pearson")
    corS[nrow(corS)+1,] <- c(s, "mock", c$estimate, c$p.value)
  }
}

corS <- corS |> 
  mutate(sign = ifelse(p < 0.05, "*", NA),
         direction = case_when(
           r < 0 ~ "convergence",
           r > 0 ~ "divergence"))

count <- data.frame(matrix(nrow=0, ncol=6))
names(count) <- c("speaker", "type", "direction", "coefficient", "mock", "real")

for(s in unique(corS$speaker)){
  count[nrow(count)+1,] <- c(s,
                             "convergence",
                             corS$direction[corS$speaker==s & corS$type=="real"],
                             corS$r[corS$speaker==s & corS$type=="real"],
                             sum(!is.na(corS$sign[corS$speaker==s & corS$type=="mock"])==TRUE),
                             ifelse(corS$sign[corS$speaker==s & corS$type=="real"]=="*", "yes", "no"))
}

count <- merge(count, dat |> select(condition, speaker) |> filter(!duplicated(speaker)), by ="speaker")

count <- count |>
  mutate_at("mock", as.numeric) |> 
  arrange(mock) |> 
  mutate(feature = "f0sd",
         section = "Lists",
         real = case_when(
           mock > 1 | is.na(real) ~ "no",
           .default = as.character(real)
         ))

all <- rbind(all, count)
```

```{r}
all <- all |> 
  mutate(sectionN = case_when(
    section=="entireExp" ~ 1,
    section=="Lists" ~ 2,
    section=="Diapix" ~ 3
  )) |> 
  rename(entrain=real) |> 
  arrange(sectionN) |> 
  select(-sectionN)
print(all |> filter(entrain=="yes"))
```

# TEMPERATURE ANALYSIS

```{r, include=FALSE}
load(paste0(here::here(), "/data/tempData.RData"))
load(paste0(here::here(), "/data/tempDataChange.RData"))
```

```{r}
all <- data.frame(matrix(nrow=0, ncol=7))
names(all) <- c("speaker", "condition", "ROI", "direction", "t", "p", "section")
```

```{r}
for(s in unique(dat$speaker)){
  for(r in unique(dat$ROI)){
    d <- dat |> filter(speaker==s, ROI==r)
    if(nrow(d)<=1){next}
    c <- tidy(lm(temperature ~ time, d))
    all[nrow(all)+1,] <- c(s, unique(d$condition), r,
                           ifelse(c$estimate[2] < 0, "negative", "positive"),
                           c$statistic[2],
                           c$p.value[2],
                           "entireExp")
    for(section in c("Lists", "Diapix")){
      d <- dat |> filter(speaker==s, ROI==r, task==section)
      if(nrow(d)==0){next}
      c <- tidy(lm(temperature ~ time, d))
      all[nrow(all)+1,] <- c(s, unique(d$condition), r,
                             ifelse(c$estimate[2] < 0, "negative", "positive"),
                             c$statistic[2],
                             c$p.value[2],
                             section)
    }
  }
}

all <- all |> 
  mutate_at(c("t", "p"), as.numeric) |> 
  mutate(sign = ifelse(p < 0.05, "yes", "ns"),
         effect = case_when(
           sign == "yes" & direction == "positive" ~ "increase",
           sign == "yes" & direction == "negative" ~ "decrease",
           sign == "ns" ~ "ns",
         )) |> 
  mutate_at(c("direction", "speaker", "effect", "condition", "section", "ROI"), as.factor)

all$section <- factor(all$section, levels=c("Lists", "Diapix", "entireExp"))
all$effect <- relevel(all$effect, ref="ns")
```

next: from line 257 of Analysis-Temperature.Rmd
